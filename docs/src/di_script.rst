.. _di_script:

*************************************
Direction-independent self-cal script
*************************************

Overview
========

The script operates by running consecutive imaging/deconvolution stages and
calibration stages, with the output of each stage feeding in to the input of
the next: a clean image is generated, the output of which is used to predict
a new set of model visibilities which WSClean writes back out to the MODEL_DATA
column of its input Measurement Set; these are then used to solve for a set
of complex gains using a GainCal step in DP3, which are then applied to the
visibilities and written back out to generate a new set of corrected data;
the new data is then used to make an improved image in WSClean, and the cycle
repeats.

After all self-calibration cycles have been completed, a final image is
generated by performing a deeper clean using the most recent corrected
visibility data.

Guidelines on the use of WSClean for self-calibration are at
https://wsclean.readthedocs.io/en/latest/selfcal.html and
https://wsclean.readthedocs.io/en/latest/basic_cleaning.html


Description of parameters
=========================

The help text for the script can be obtained by
running ``selfcal_di.py --help``, and is reproduced below:

.. code-block:: none

  usage: selfcal_di.py [-h] [-n CLEAN_ITERS] [-p PHASE_ONLY_CYCLES]
                       [-s INITIAL_SKY_MODEL] -w WSCLEAN_EXTRA_PARAMS
                       ms_in image_out

  Runs a direction-independent self-calibration loop using DP3 (gaincal) and
  WSClean. Example usage: python3 selfcal_di.py
  --clean_iters="20,100,500,500000" --phase_only_cycles="0"
  --wsclean_extra_params="-size 16384 16384 -scale 1asec -parallel-deconvolution
  2500 -gridder wgridder" v12p1_actual_ical_TGcal_900s.ms selfcal_out

  positional arguments:
    ms_in                 name of input Measurement Set
    image_out             name of output FITS image

  optional arguments:
    -h, --help            show this help message and exit
    -n CLEAN_ITERS, --clean_iters CLEAN_ITERS
                          Maximum Clean iterations per self-cal cycle, as a
                          quoted list. The number of calibration cycles is one
                          less than the length of the list, as the final value
                          is used to make the image after the last calibration.
                          (default: 20,100,500,500000)
    -p PHASE_ONLY_CYCLES, --phase_only_cycles PHASE_ONLY_CYCLES
                          Comma-separated list of self-cal cycle indices (zero-
                          based) in which to perform phase-only calibration. The
                          default is to run a phase-only calibration for the
                          first cycle. (default: 0)
    -s INITIAL_SKY_MODEL, --initial_sky_model INITIAL_SKY_MODEL
                          Optional path to a DP3 sky model file to use for an
                          initial calibration, before the self-cal starts.
                          (default: None)
    -w WSCLEAN_EXTRA_PARAMS, --wsclean_extra_params WSCLEAN_EXTRA_PARAMS
                          Extra parameters for WSClean (e.g. image size and
                          pixel scale). Apart from the input and output names,
                          the only ones set by this script are -niter, -mgain
                          (0.8), and -auto-threshold (3). (default: None)

The maximum number of clean iterations to use for each self-calibration cycle
is specified using the ``-n`` or ``--clean_iters`` option, which should be given
as a list of integers.
The length of the list determines the number of self-calibration cycles to
perform, which is one less than list length, as the final value specifies
the maximum number of iterations to use to make the final image.
The values used here will likely be heavily dependent on the quality of the
input data and the distribution of sources in the target field.

It is usual to perform a phase-only calibration for at least the first
self-calibration cycle.
The cycles in which to run a phase-only calibration can be specified using
the ``-p`` or ``--phase_only_cycles`` option, which should be given as a list
of (zero-based) cycle indices.

It may be helpful to supply an external sky model file to bootstrap the
calibration, which can optionally be given using the ``-s``
or ``--initial_sky_model`` option.
If supplied, this should be the filename of a DP3-format sky model file.

Most of the imaging parameters must be specified using the ``-w``
or ``--wsclean_extra_params`` option. This must be given as a quoted string
containing all the extra parameters to pass to WSClean in order to make
the images. These should include the pixel scale (specified
as ``-scale <value>``) and image size (specified as ``-size <x> <y>``) and any
other imaging options required (for example, ``-parallel-deconvolution 2500``
and ``-gridder wgridder`` were recommended by Andre Offringa).
Apart from the input and output names, the only other parameters set
internally by this script are ``-niter``, ``-mgain`` (0.8),
and ``-auto-threshold`` (3).

The final two command line arguments are the file names of the input
Measurement Set and output FITS image, which are given as positional arguments.

Download the Python script here:
:download:`selfcal_di.py <../../src/selfcal_di.py>`

.. literalinclude:: ../../src/selfcal_di.py
