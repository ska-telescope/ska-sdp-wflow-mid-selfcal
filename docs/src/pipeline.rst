.. _pipeline:

**************
Pipeline Usage
**************

Overview
========

The pipeline operates by running consecutive imaging/deconvolution stages and
calibration stages, with the output of each stage feeding in to the input of
the next: a clean image is generated, the output of which is used to predict
a new set of model visibilities which WSClean writes back out to the MODEL_DATA
column of its input Measurement Set; these are then used to solve for a set
of complex gains using a GainCal step in DP3, which are then applied to the
visibilities and written back out to generate a new set of corrected data;
the new data is then used to make an improved image in WSClean, and the cycle
repeats.

After all self-calibration cycles have been completed, a final image is
generated by performing a deeper clean using the most recent corrected
visibility data.

Guidelines on the use of WSClean for self-calibration are at
https://wsclean.readthedocs.io/en/latest/selfcal.html and
https://wsclean.readthedocs.io/en/latest/basic_cleaning.html


Description of parameters
=========================

The help text for the pipeline app can be obtained by running
``mid-selfcal-pipeline --help``, and is reproduced below:

.. code-block:: none

  usage: mid-selfcal-pipeline [-h] [--version] [--singularity-image SINGULARITY_IMAGE] [--base-outdir BASE_OUTDIR] --size SIZE SIZE --scale SCALE [--weight WEIGHT [WEIGHT ...]]
                              [--initial-sky-model INITIAL_SKY_MODEL] [--gaincal-solint GAINCAL_SOLINT] [--gaincal-nchan GAINCAL_NCHAN] [--clean-iters [CLEAN_ITERS ...]]
                              [--final-clean-iters FINAL_CLEAN_ITERS] [--phase-only-cycles [PHASE_ONLY_CYCLES ...]] --input-ms INPUT_MS [INPUT_MS ...]

  Launch the SKA Mid self-calibration pipeline

  optional arguments:
    -h, --help            show this help message and exit
    --version             show program's version number and exit
    --singularity-image SINGULARITY_IMAGE
                          Optional path to a singularity image file with both WSClean and DP3 installed. If specified, run WSClean and DP3 inside singularity containers; otherwise, run
                          them on bare metal. (default: None)
    --base-outdir BASE_OUTDIR
                          Base output directory; a uniquely named sub-directory will be created, in which all products will be written. (default: /home/vince/repositories/ska-sdp-wflow-
                          mid-selfcal)
    --size SIZE SIZE      Output image size as two integers <width> <height> (default: None)
    --scale SCALE         Scale of a pixel, as a string such as "20asec" or "0.01deg". (default: None)
    --weight WEIGHT [WEIGHT ...]
                          Weighting mode, either 'natural', 'uniform' or briggs <R>', where `R` is the Briggs robustness parameter, a real-valued number between -2.0 and 2.0. (default:
                          uniform)
    --initial-sky-model INITIAL_SKY_MODEL
                          Optional path to a DP3 sky model file to use for an initial calibration, before the self-cal starts. (default: None)
    --gaincal-solint GAINCAL_SOLINT
                          gaincal.solint parameter for DP3: number of time slots over which a solution is assumed to be constant (default: 1)
    --gaincal-nchan GAINCAL_NCHAN
                          gaincal.nchan parameter for DP3: number of channels over which a solution is assumed to be constant (default: 0)
    --clean-iters [CLEAN_ITERS ...]
                          Maximum Clean iterations per self-cal cycle, as a list of integers. This does not include the final imaging stage, where the image is deconvolved down to the
                          noise floor. To run only the final imaging stage without selfcal, specify this argument without a value. (default: [20, 100, 500])
    --final-clean-iters FINAL_CLEAN_ITERS
                          Maximum Clean iterations for the final imaging stage. (default: 100000)
    --phase-only-cycles [PHASE_ONLY_CYCLES ...]
                          List of self-cal cycle indices (zero-based) in which to perform phase-only calibration. A reasonable default is to run a phase-only calibration for the first
                          cycle. To avoid doing any phase-only cal cycles, specify this argument without a value. (default: [0])
    --input-ms INPUT_MS [INPUT_MS ...]
                          Input measurement set(s). (default: None)


Input and output paths
----------------------

First the input measurement set file (or list of files) must be specified via ``--input-ms``.
The input data can be given as multiple measurement sets, which contain visibilities from different frequency bands as long as they originate from the exact same observation.

On startup, the pipeline creates a uniquely-named directory where it will store its products, as well as any temporary files created by DP3 and WSClean.
``--base-outdir`` allows to specify the parent directory inside which this uniquely-named output directory will be created.
Currently, the naming pattern is ``selfcal_YYYMMDD_HHMMSS_<MICROSECONDS>``, i.e. based on the date and time the pipeline started processing.


Optional: running WSClean and DP3 within singularity containers
---------------------------------------------------------------

By default, the pipeline assumes that WSClean and DP3 are installed on the host and attempts to run them on bare metal.
Alternatively, it is possible to specify a singularity image file via ``--singularity-image`` inside which both WSClean and DP3 are expected to be installed.
In that case, the pipeline will run WSClean and DP3 inside singularity containers spun up from that image file,
i.e. automatically generate and execute the right singularity commands with the appropriate bind mount points.


Optional: initial calibration
-----------------------------

It may be helpful to supply an external sky model file to bootstrap the calibration, which can optionally be given using the ``--initial-sky-model`` option.
If supplied, this should be the filename of a DP3-format sky model file.


Self-calibration loop control
-----------------------------

The maximum number of clean iterations to use for each self-calibration cycle is specified using the ``--clean-iters`` option.
It must be given as a space-separated list of integers, e.g. ``--clean-iters 20 100 500``.

The length of the list determines the number of self-calibration cycles to perform.
The values used here will likely be heavily dependent on the quality of the input data and the distribution of sources in the target field.

It is usual to perform a phase-only calibration for at least the first self-calibration cycle. 
The cycles in which to run a phase-only calibration can be specified using the ``--phase-only-cycles`` option.
It should be given as a list of (zero-based) cycle indices, e.g. ``--phase-only-cycles 0 1``.

After the self-calibration cycles are complete, the pipeline performs a final imaging step,
using a maximum number of clean iterations that is 100,000 by default; the number can be tweaked through ``--final-clean-iters``.
As an example, suppose we specified the following:

.. code-block::

  --clean-iters 30 200
  --phase-only-cycles 0
  --final-clean-iters 942000

Then the following workflow would be executed:  

- Make an initial image using a maximum of 30 clean iterations
- Do a phase-only calibration of the data against the resulting model
- Make an image using a maximum of 200 clean iterations
- Do a phase + amplitude calibration of the data against the resulting model
- Make the final image using a maximum of 942,000 clean iterations

.. note::

  It is possible to produce the final image directly, without any self-calibration cycles.
  To do this, specify explicitly ``--clean-iters`` without a value.


Image size and scale
--------------------

The parameters of the output image must be specified via ``--size`` and ``--scale``.
``--size`` is the width and height of the image in pixels
``-scale`` is the angular scale of a pixel as a string parseable by WSClean.
Example: ``--size 10000 10000 --scale 0.5asec``.


Weighting mode
--------------

The weighting mode used by WSClean can be tweaked via ``--weight``, options are:

- ``uniform``
- ``natural``
- ``briggs <R>``, where the robustness parameter R should be between -2.0 (close to uniform weighting) to 2.0 (close to natural).


Calibration solution intervals
------------------------------

The parameters ``--gaincal-solint`` and ``-gaincal-nchan`` control the calibration solution intervals in both time and frequency, for all calibration stages including initial calibration (if specified). 
These are directly forwarded to DP3's GainCal as ``gaincal.solint`` and ``gaincal.nchan``.

``--gaincal-solint``: The number of time samples over which a calibration solution is considered constant.

``--gaincal-nchan``: The number of frequency channels over which a calibration solution is considered constant.

Refer to the `DP3 GainCal documentation <https://dp3.readthedocs.io/en/latest/steps/GainCal.html>`_ for full details.
